import { Callout } from "nextra-theme-docs";
import { ExternalLink } from "@/components";
import { SWAGGER_TAGS } from "@/constants";
import { loadWebhooksStatic } from "@/utils";
import { WebhooksSchemaLoader } from "./webhooks-api/utils";

export const getStaticProps = loadWebhooksStatic;

# Webhooks API

Human‑friendly guide to using TONAPI Webhooks. Full schemas and exhaustive field lists live in Swagger (rt.yml). This page focuses on what matters in practice: how delivery works, how to authenticate, and how to operate reliably.

## What it is and why

- **Webhooks** let you subscribe to on‑chain events and receive POST notifications to your endpoint. The most common case is inbound transactions for specific accounts. The payload includes `account_id`, `lt` and `tx_hash`.
- **Base URLs**: mainnet `rt.tonapi.io`, testnet `rt-testnet.tonapi.io` (same paths as mainnet).
- **API Key**: management methods require a private API key via `Authorization: Bearer …` or `?token=…`. Your key must have Webhooks management enabled in TonConsole (webhooks are billed separately).

## Event payload (account transactions)

Readable “web schema” for account transaction notifications:

```ts
type AccountTransactionEvent = {
  account_id: string; // raw address, e.g. "0:8f2d84…"
  lt: number;        // logical time
  tx_hash: string;   // transaction hash
};
```

Production example:

```json
{
  "account_id": "0:8f2d840ec05d118f98459a057b1fcab535c57b9371222be15667fee932ceaf53",
  "lt": 49739623000001,
  "tx_hash": "653e593d581ad40d5d0868fe5d60008e1bfe9d2d4c4fa6b2ee5cd458741d7b59"
}
```

Refer to the Webhooks API page for other subscription payloads and details.

## Delivery and retries

<Callout type="warning" emoji="⚠️">
  Delivery is <strong>at‑least‑once</strong>. Duplicates and out‑of‑order delivery are possible. Implement idempotency.
</Callout>

- **Ack protocol**
  - Any HTTP **2xx** within a reasonable timeout → treated as delivered.
  - **5xx** or timeout → retried with exponential backoff.
  - **4xx** (except `408`/`429`) → not retried. `408`/`429` are treated as temporary and retried.
- **Idempotency key**: use the tuple `(account_id, lt, tx_hash)` to deduplicate.
- **Operational tips**
  - Return a “quick ACK” (e.g., `204`/`200`) and process asynchronously.
  - Keep a per‑account checkpoint of the last processed `lt` to recover quickly.
  - Monitor subscription counters: `last_delivered_lt`, `failed_at`, `failed_lt`, `failed_attempts`.

## Authenticating incoming webhook requests

Two complementary options:

- **Secret token in headers**
  When you create a webhook the API returns a `token`. TONAPI includes this token in headers for every notification. Compare it to your stored token to verify the sender. You can rotate the token via `POST /webhooks/{webhook_id}/generate-new-token` (the old token becomes invalid).

- **Secret path segment**
  Add a unique segment to your endpoint (e.g., `/webhooks/ab12cdef-…`) and accept notifications only at that URL.

Recommendations:

- Do not log the secret verbatim; have a rotation procedure.
- Compare tokens exactly (no trimming/normalization).

### Operations

<WebhooksSchemaLoader />

## Testnet

Use the same API on `rt-testnet.tonapi.io`.

## Recovery and self‑healing

- On service startup, load current subscriptions via `GET /…/account-tx/subscriptions` and note `last_delivered_lt` per account.
- If events were missed, backfill via REST (e.g., Traces) and process locally with the same idempotency `(account_id, lt, tx_hash)`.
- When your receiver is back online, call `POST /webhooks/{id}/back-online` and review `GET /…/logs`.

## FAQ

- **Do you guarantee ordering?** Not across different accounts. Rely on `lt` and deduplicate.
- **What response should we send?** Any `2xx` is success. For heavy processing, return `204` and use an async pipeline.
- **Where can we see delivery errors?** `GET /webhooks/{id}/logs` and the `failed_*` counters in subscriptions.

## Integrator checklist

- API key with Webhooks permissions enabled in TonConsole.
- Created webhook → stored `webhook_id` and secret `token`.
- Receiver validates the header token and/or uses a secret path.
- Immediate `2xx` ACK; idempotency on `(account_id, lt, tx_hash)`.
- Per‑account checkpoint on `lt`; backfill via REST if needed.
- Monitoring: `failed_*`, `logs`, alerts on error growth.

## Links

- <ExternalLink href="https://tonapi.io/webhooks-api">Webhooks API (tonapi.io)</ExternalLink>
- <ExternalLink href="https://raw.githubusercontent.com/tonkeeper/opentonapi/master/api/rt.yml">Swagger rt.yml (raw)</ExternalLink>
- <ExternalLink href="https://tonconsole.com/tonapi/webhooks">TonConsole Playground</ExternalLink>
