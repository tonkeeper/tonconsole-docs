import { Callout } from 'nextra-theme-docs';

# Jetton Airdrop

Service enables a mass token distribution model where the recipient pays a fixed fee in TONs and receives Jettons.
The distribution is carried out to a fixed list of recipients. In the following, we will refer to the Jetton distribution process as an **Airdrop**.

## How it works
1. The Airdrop organizer (**Airdrop admin**) prepares a file with a fixed list of Jetton recipients
2. The Airdrop admin creates a new project in Ton Console and fills in the airdrop data
3. The Airdrop admin connects his wallet via TON Connect (in Ton Console) and deploys the Airdrop smart contracts
4. The Airdrop admin on his hosting raises a dApp that allows the recipient to connect his wallet and receive Jettons by paying a Claim Fee

## Airdrop file preparation

<Callout type="warning" emoji="ðŸš¨">
    Only the account specified in the Airdrop file can claim.
    The Airdrop file must include addresses that are wallets in the TON blockchain supported by the Ton Connect protocol.
</Callout>

### File format requirements
1. CSV format with a comma delimiter
2. Contain a header in the format: `recipients, amount`
3. Jetton amount in minimal indivisible units (example: `1000000` for 1 USDT where decimals=6). The value must be positive, and decimal points are not allowed
4. Recipient wallet addresses in user-friendly or raw format ([Address formats](https://docs.ton.org/v3/documentation/smart-contracts/addresses#raw-and-user-friendly-addresses)) with no duplicates
5. File size no more than 500 MB (~ 6,400,000 records). More upon individual request

### File example
```csv
recipient,amount
0:d0ef5351eb05503c10a447543113b315e772d147c51aaa81aa308b5cae99e07e,2567953998
0:199b41bcda2472b057d72f80e2e8ba5e15dcb776e68c9eeea393dad668248068,3127429615
0:aa1e7af003374652e13f705b8c7010b3cf8708f5f98f43c999b8ec4e2c0e0cdf,562536354
```

## Airdrop Admin

When creating a new airdrop in Tonconsole, you will need to connect your wallet via Ton Connect.
The address of this wallet will be recorded as the Airdrop Admin address for the contracts.

<Callout type="warning" emoji="ðŸš¨">
    Only Admin will be able to manage the distribution (such as completing the distribution and withdrawing accumulated profit).
    To send messages in batches, a wallet capable of sending 255 messages is required. Ton Console requires connecting only a W5 wallet.
</Callout>

## Jetton for distribution

To create an Airdrop you will need to specify the address of the Jetton master contract ([Jetton Architecture](https://docs.ton.org/v3/guidelines/dapps/asset-processing/jettons#jetton-architecture)) in user-friendly or raw format.
For example: Notcoin address is EQAvlWFDxGF2lXm67y4yzC17wYKD9A0guwPkMs1gOsM__NOT ([Tonviewer](https://tonviewer.com/EQAvlWFDxGF2lXm67y4yzC17wYKD9A0guwPkMs1gOsM__NOT)).

If you have created a Jetton not based on the standard smart contract or are sending a Jetton minted by someone else, be cautious.
Custom smart contract logic may disrupt the distribution process (e.g. due to unreasonably high transfer fees). Use only trusted Jettons.

<Callout type="warning" emoji="ðŸš¨">
  Before starting distributions with new Jettons, be sure to conduct a test run with a small number of recipients.
</Callout>

## Claim Fee

This is a key airdrop setting. It determines how much the user will pay to claim and how much TON the organizers will receive.

When a user signs a claim message via Ton Connect, they pay a `Claim fee` in TON for the distribution contract to accept the message.
In addition to the fee, the user also pays a network fee for sending this message.

Example:
```
claim_fee = 0.15 TON
blockchain_fee(forward_fee + gas_fee + ...) = ~0.0076 TON
user_pays = claim_fee + blockchain_fee = 0.15 + ~0.0076 = ~0,1576 TON
```

## Profit sharing

The `Claim fee` is used to cover all network fees incurred during the claim process, and the remainder of this amount is sent to special distribution smart contracts.

Example of a claim operation in the testnet: [Tonviewer](https://testnet.tonviewer.com/transaction/7076abbeb1a4e614965ed5f97b8e400bb2227aca54a72b60f2e373d2d0a92207).

In the given example, the distributor contract will receive `excess` = 0.1147384 TON.
Real balance change = +0.112809142 TON and slightly less than `excess` due to blockchain fees. You can estimate it in the `Value flow` tab.

The TONs received by the distributor contract is divided in the following proportion:
`royalty_receiver_share = fraction * excess` and the remaining amount is the `admin_share`.

Check with the [t.me/tonrostislav](https://t.me/tonrostislav)([rostislav.r@tonkeeper.com](mailto:rostislav.r@tonkeeper.com)) for the current values of coefficient `fraction`.

<Callout type="warning" emoji="ðŸš¨">
  Keep in mind that blockchain fees may vary depending on the Jettons contracts and other factors (e.g., the presence of a deployed Jetton wallet for the recipient).
  Therefore, the provided values are approximate. For more accurate estimates, you can conduct test Airdrop.
</Callout>

## dApp for users to claim Jettons

Airdrop organizers should deploy a dApp on their side (website, landing page) where the claim recipient can connect their wallet via Ton Connect and sign a claim message.

You can find the reference application here: [GitHub](TODO: add).

### API for dApp interaction

The TonAPI backend has a method for interacting with the claim dApp. Through it, the dApp receives the necessary data for the recipient.

When you click the `Enable claim` button in the Ton Console dashboard, you grant users access to this method; when you click `Disable claim`, you close it.

`GET {host}/v1/airdrop/claim/{address}?id={airdrop_id}`

Returns:
```json
{
  "claim_message": {
    "mode": 3,
    "address": "EQDkQoYBAf4ibjg7xbwitIuXSOyLii-BG6X4Rv-ZePzL3Kfq",
    "state_init": "base64string",
    "payload": "base64string",
    "amount": "150000000"
  },
  "amount": "616161783"
}
```

Where request parameters:
1. `host` - address of claim API: `https://mainnet-airdrop.tonapi.io`
2. `address` - recipient address in raw form. Example: `0:585eacf04d4df6c8a2e4f1ed1008e1ac3e36e14cbc37cddaf1f329a50ad43853`
3. `airdrop_id` - unique Airdrop identifier from the Airdrop dashboard in Ton Console. Example: `fa541433-ceef-4286-a76c-1be7c6198632`

The dApp takes the `address` from the wallet address connected via Ton Connect.

Where response parameters:

`claim_message` - contains the data necessary for forming a message via Ton Connect
1. `mode` - message sending mode (Ton Connect always sends with mode 3)
2. `address` - destination address of the message in user-friendly format containing the bounce flag
3. `state_init` - serialized state init cell in base64 format
4. `payload` - serialized body cell in base64 format
5. `amount` ("150000000") - amount of TONs attached to the message (`Claim Fee`)

`amount` ("616161783") - Jetton amount in minimal indivisible units (from the Airdrop file)

To reduce API load, token data is not transmitted in this method.
However, since a specific dApp is responsible for a specific Airdrop, the Jetton data can be hardcoded on the application's side or retrieved by the dApp via TonAPI.

### Test claim button

<Callout type="warning" emoji="ðŸš¨">
  It is used for testing purposes and leads to a reference implementation of the application. 
  Do not use it for production distribution, as it is not intended for that and does not guarantee reliable operation.
</Callout>

## Distribution completion procedure

Before withdrawing profit and remaining Jettons, you need to properly complete the distribution to prevent users from attempting to claim tokens after the distribution has ended.

First, you need to click the `Disable claim` button to deactivate the API claim endpoint through the dApp.
Second, click the `Complete airdrop` button to send special messages that lock the distribution contracts.
After this, you can safely withdraw the remaining tokens and accumulated TONs from the distribution contracts to the Admin`s address.
